/*
last states:
h0 0.542201 -0.448965 0.369368 0.469707 0.159998 -0.0408811 -0.576257 0.0189195 0.259704 -0.133216 0.818684 -0.29238 -0.64537 -0.320844 0.415202 -0.278697 0.026337 0.0717919 -0.231787 -0.00202289 0.518979 -0.391275 0.60087 0.955079 0.579935 0.479937 0.510131 0.676292 -0.67526 0.647449 -0.54166 -0.477752 -0.585685 0.604838 0.115211 -0.026481 -0.751432 -0.507601 -0.443031 0.380994 -0.539141 -0.272593 -0.320975 -0.610345 0.612841 -0.0395134 0.208105 0.755278 0.286718 0.828283 0.311027 0.451566 0.0833225 0.474269 0.293152 -0.443122 0.399745 0.535991 0.647006 0.462829 -0.434534 0.156241 0.0446106 -0.721302 0.446695 -0.309785 0.29033 -0.603248 0.134116 0.608555 0.315146 -0.309758 0.525318 0.745563 -0.694516 0.249327 0.438807 0.490846 0.460262 0.26644 -0.179501 0.36432 -0.468004 0.386942 -0.633813 0.473034 0.728193 -0.17183 0.731633 0.671165 0.7523 0.0202927 0.0150367 0.476954 0.649012 -0.508707 -0.534874 0.665354 -0.184449 -0.540054 0.575901 0.260195 -0.525114 -0.464082 -0.577358 -0.636794 0.600312 -0.502005 -0.779736 -0.307247 -0.25919 -0.222617 0.255229 -0.606202 -0.565816 -0.463786 -0.199402 0.590222 -0.328744 0.132953 0.772215 -0.41729 0.195371 -0.404923 0.351882 -0.623052 0.746801 0.322117
h1 -0.215683 0.261144 0.152136 0.230827 0.241893 -0.135916 -0.501124 0.213801 -0.0891912 0.128417 0.449249 0.14041 -0.0578912 -0.019833 -0.415201 -0.260446 0.169586 0.468362 0.0692268 -0.540423 -0.0671551 0.167839 -0.255314 0.165571 0.0173317 -0.196604 -0.549298 0.450661 0.477592 0.261334 0.856012 -0.0440622 0.091452 -0.608315 0.545175 -0.457574 -0.257878 -0.132263 0.213911 -0.110636 -0.65769 -0.495549 0.198763 -0.416977 -0.244154 0.289122 -0.287704 0.396773 0.556752 0.277279 0.0676805 -0.0280411 0.121989 -0.24359 -0.531601 0.167765 0.230238 -0.120985 -0.221184 0.00485784 -0.456228 -0.107815 -0.0890474 0.0438631 0.457989 -0.32513 -0.285162 0.109964 -0.036463 -0.0063667 0.304685 0.493096 0.00150468 0.152618 -0.21209 0.496103 0.163187 0.0966501 -0.338388 0.326681 -0.439387 0.178118 0.493431 -0.208092 0.0310283 0.125479 -0.380033 0.212845 0.0436273 -0.220434 -0.00529123 -0.270784 0.176816 -0.274781 -0.066839 -0.253255 0.178133 0.0424597 0.566595 -0.489567 0.264927 0.341308 -0.013394 -0.087241 -0.0523064 -0.629331 -0.135625 0.189859 0.16114 0.140829 0.266246 0.011806 0.447146 -0.179227 -0.00410788 0.193417 0.0180293 -0.703333 0.140468 0.168142 -0.079653 -0.0936932 0.244671 0.0449156 0.0427885 0.331196 -0.126037 0.287817
bits:
h0 2095 63720 1464 1882 428 65322 63218 55 837 64786 3318 64330 62945 64228 1615 64364 78 325 64674 65401 2103 63954 2320 3846 2238 1922 2034 2716 62852 2485 63309 63666 63187 2461 369 65407 62515 63491 63785 1440 63358 64462 64200 63109 2416 65380 769 3059 1154 3330 1044 1840 306 1915 1143 63776 1593 2157 2621 1543 63798 524 370 62617 1736 64272 1074 63136 537 2457 1277 64320 2166 1955 62730 981 1778 2005 1827 1063 64918 1454 63665 1425 62997 1859 2964 65000 2874 2710 2670 31 65345 1938 2640 63468 63423 2686 64782 63376 2278 1070 63410 63665 63203 62925 2426 63486 62390 64319 64415 64671 950 63100 63240 63640 64769 2327 64162 280 3112 63863 361 63868 1422 62983 2993 1245
h1 64636 1001 521 905 1027 64939 63507 990 65220 619 1767 552 65254 65410 63827 64406 491 1908 195 63235 65161 631 64522 598 65498 64637 63305 1857 1900 1092 3454 65181 243 63025 2204 63668 64501 65013 537 65132 62846 63531 784 63780 64586 1098 64410 1531 2275 921 423 65528 415 64533 63390 547 818 65074 64711 65440 63712 65046 65114 181 1893 64194 64329 374 65401 65486 1259 2013 64868 520 64646 1966 577 279 64059 1272 63751 653 2013 64501 25 475 63998 889 69 64674 46 64414 701 64328 65188 64426 655 149 2226 63506 1060 1393 65418 65188 65269 62935 64925 772 555 570 1047 65434 1720 64817 65244 657 65478 62678 572 528 65194 65038 982 156 65337 1234 64975 1062

0.842041
4:  4
*/

#include "parameters.h"
#include "lstm.h"
#include "../../hlslib/fic_utils/fic_packet.h"
#include "../../test_data/test_digit_4.h"

void bidirectional_lstm(ap_uint<4> rx_start,
               data_t res[N_OUTPUTS])
{
#pragma HLS INTERFACE axis port = rx_start
#pragma HLS INTERFACE axis port = res

    data_t Why[N_OUTPUTS][2*N_STATES] = WHY;
    data_t by[N_OUTPUTS] = BY;

    data_t W_i[N_STATES][N_INPUTS]=W_I, W_f[N_STATES][N_INPUTS]=W_F, W_c[N_STATES][N_INPUTS]=W_C, W_o[N_STATES][N_INPUTS]=W_O;
    data_t U_i[N_STATES][N_STATES]=U_I, U_f[N_STATES][N_STATES]=U_F, U_c[N_STATES][N_STATES]=U_C, U_o[N_STATES][N_STATES]=U_O;
    data_t b_i[N_STATES]=B_I, b_f[N_STATES]=B_F, b_c[N_STATES]=B_C, b_o[N_STATES]=B_O;

    data_t W1_i[N_STATES][N_INPUTS]=W1_I, W1_f[N_STATES][N_INPUTS]=W1_F, W1_c[N_STATES][N_INPUTS]=W1_C, W1_o[N_STATES][N_INPUTS]=W1_O;
    data_t U1_i[N_STATES][N_STATES]=U1_I, U1_f[N_STATES][N_STATES]=U1_F, U1_c[N_STATES][N_STATES]=U1_C, U1_o[N_STATES][N_STATES]=U1_O;
    data_t b1_i[N_STATES]=B1_I, b1_f[N_STATES]=B1_F, b1_c[N_STATES]=B1_C, b1_o[N_STATES]=B1_O;

 #pragma HLS ARRAY_PARTITION variable = W_i complete dim = 2
 #pragma HLS ARRAY_PARTITION variable = W_f complete dim = 2
 #pragma HLS ARRAY_PARTITION variable = W_c complete dim = 2
 #pragma HLS ARRAY_PARTITION variable = W_o complete dim = 2

 #pragma HLS ARRAY_PARTITION variable = U_i cyclic factor=32 dim = 2
 #pragma HLS ARRAY_PARTITION variable = U_f cyclic factor=32 dim = 2
 #pragma HLS ARRAY_PARTITION variable = U_c cyclic factor=32 dim = 2
 #pragma HLS ARRAY_PARTITION variable = U_o cyclic factor=32 dim = 2

 #pragma HLS ARRAY_PARTITION variable = b_i cyclic factor=32 dim = 1
 #pragma HLS ARRAY_PARTITION variable = b_f cyclic factor=32 dim = 1
 #pragma HLS ARRAY_PARTITION variable = b_c cyclic factor=32 dim = 1
 #pragma HLS ARRAY_PARTITION variable = b_o cyclic factor=32 dim = 1

#pragma HLS ARRAY_PARTITION variable = W1_i complete dim = 2
#pragma HLS ARRAY_PARTITION variable = W1_f complete dim = 2
#pragma HLS ARRAY_PARTITION variable = W1_c complete dim = 2
#pragma HLS ARRAY_PARTITION variable = W1_o complete dim = 2

#pragma HLS ARRAY_PARTITION variable = U1_i cyclic factor=32 dim = 2
#pragma HLS ARRAY_PARTITION variable = U1_f cyclic factor=32 dim = 2
#pragma HLS ARRAY_PARTITION variable = U1_c cyclic factor=32 dim = 2
#pragma HLS ARRAY_PARTITION variable = U1_o cyclic factor=32 dim = 2

#pragma HLS ARRAY_PARTITION variable = b1_i cyclic factor=32 dim = 1
#pragma HLS ARRAY_PARTITION variable = b1_f cyclic factor=32 dim = 1
#pragma HLS ARRAY_PARTITION variable = b1_c cyclic factor=32 dim = 1
#pragma HLS ARRAY_PARTITION variable = b1_o cyclic factor=32 dim = 1

#pragma HLS ARRAY_PARTITION variable = Why complete dim = 2
 #pragma HLS ARRAY_PARTITION variable = by complete

    static data_t h0_oldstate[N_STATES] = {0};
    static data_t c0_oldstate[N_STATES] = {0};
    static data_t h1_oldstate[N_STATES] = {0};
    static data_t c1_oldstate[N_STATES] = {0};

    static data_t h0_newstate[N_STATES] = {0};
    static data_t c0_newstate[N_STATES] = {0};
    static data_t h1_newstate[N_STATES] = {0};
    static data_t c1_newstate[N_STATES] = {0};

 #pragma HLS ARRAY_PARTITION variable = h0_oldstate cyclic factor=32
 #pragma HLS ARRAY_PARTITION variable = c0_oldstate cyclic factor=32
#pragma HLS ARRAY_PARTITION variable = h1_oldstate cyclic factor=32
#pragma HLS ARRAY_PARTITION variable = c1_oldstate cyclic factor=32

#pragma HLS ARRAY_PARTITION variable = h0_newstate cyclic factor=32
#pragma HLS ARRAY_PARTITION variable = c0_newstate cyclic factor=32
#pragma HLS ARRAY_PARTITION variable = h1_newstate cyclic factor=32
#pragma HLS ARRAY_PARTITION variable = c1_newstate cyclic factor=32

    data_t test_row[N_INPUTS];
    data_t test_row_rev[N_INPUTS];
#pragma HLS ARRAY_PARTITION variable=test_row cyclic factor=4
#pragma HLS ARRAY_PARTITION variable=test_row_rev cyclic factor=4
#pragma HLS ARRAY_PARTITION variable=image_digit_4 cyclic factor=4 dim=2

    ap_uint<169> packets_test[16];
    for (int iloop = 0; iloop < N_LOOP; iloop++)
    {
        for (int i = 0; i < N_INPUTS; i++){
            test_row[i] = image_digit_4[iloop][i];
//            test_row_rev[i] = image_digit_4[N_INPUTS-1-iloop][i];
        }

        nn::lstm_static<data_t, config0, cell_act_config, recurrent_act_config>(test_row, h0_oldstate, h0_newstate, c0_oldstate, c0_newstate, W_i,W_f,W_c,W_o,
        		U_i,U_f,U_c,U_o, b_i, b_f, b_c, b_o);
        // fic::encoder<data_t, packet_config>(h0_newstate, packets_test);
        // fic::decoder<data_t, packet_config>(packets_test, h0_newstate);
        nn::lstm_static<data_t, config0, cell_act_config, recurrent_act_config>(test_row_rev, h1_oldstate,h1_newstate, c1_oldstate,c1_newstate, W1_i,W1_f,W1_c,W1_o,
        		U1_i,U1_f,U1_c,U1_o, b1_i, b1_f, b1_c, b1_o);
//        std::cout << "h0 "; for (int ii = 0; ii < N_STATES; ii++) std::cout << h0_newstate[ii].range()<< " "; std::cout << std::endl;
//        std::cout << "h1 "; for (int ii = 0; ii < N_STATES; ii++) std::cout << h1_newstate[ii].range()<< " "; std::cout << std::endl;
    }

    data_t y[N_OUTPUTS] = {0};
#pragma HLS ARRAY_PARTITION variable = y complete
    data_t h_concat[N_STATES*2];
#pragma HLS ARRAY_PARTITION variable = h_concat complete
    for (int i=0; i<N_STATES; i++)
    {
#pragma HLS unroll
        h_concat[i] = h0_newstate[i];
        h_concat[i+N_STATES] = h1_newstate[i];
    }
//    nn::fc<data_t, config1::n_state * 2, config1::n_out>(Why, h_concat, by, y);
//    nn::softmax<data_t, data_t, softmax_config>(y, res);
//
//    // reset memory between calls
//    for (int i = 0; i < N_STATES; i++)
//    {
//#pragma HLS unroll
//        h0_oldstate[i] = 0;
//        c0_oldstate[i] = 0;
//        h1_oldstate[i] = 0;
//        c1_oldstate[i] = 0;
//    	h0_newstate[i] = 0;
//        c0_newstate[i] = 0;
//        h1_newstate[i] = 0;
//        c1_newstate[i] = 0;
//    }
}
